<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/pygments.css">
    <link rel="stylesheet" href="/css/styles.css">
    <title>Analysing the `KiUserExceptionDispatcher` instrumentation hook</title>
  </head>
  <body>
    <header>
      <p>m. taujanskas</p>
      <p>-</p>
      
  <p style="margin-left:1em;font-style:italic;">&gt; Analysing the `KiUserExceptionDispatcher` instrumentation hook</p>

    </header>
    <main>
      
  <p>A fundamental stack memory structure is referenced relative to <code>rbp</code>, <code>0x2368 (9064)</code> bytes large. It is the local variable space for the function, and it significantly padded with garbage values and opaque predicate determinates. We can assume that the first parameters of this function are identical to the real <code>KiUserExceptionDispatcher</code> function, thus:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">hook_KiUserExceptionDispatcher</span><span class="w"> </span><span class="p">(</span><span class="n">PEXCEPTION_RECORD</span><span class="w"> </span><span class="n">exc_record</span><span class="p">,</span><span class="w"> </span><span class="n">PCONTEXT</span><span class="w"> </span><span class="n">exc_context</span><span class="p">)</span>
</code></pre></div>

<p>Passed in <code>rcx</code>/<code>rdx</code> respectively, per the standard Windows calling convention. Note that decompilation has been significantly cleaned through eliminating simple opaque predicates and renamed data references. The first order of business:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">uint64_t</span><span class="w"> </span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zx</span><span class="p">.</span><span class="n">q</span><span class="p">(</span><span class="n">table_1_index</span><span class="p">)</span>
<span class="kt">char</span><span class="w"> </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_1</span><span class="p">)[</span><span class="n">table_1_index_2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">0.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">r8</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">1.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span>
<span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="kt">char</span><span class="w"> </span><span class="n">r8_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_1</span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">2.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">r8_2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">3.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span>
<span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="kt">char</span><span class="w"> </span><span class="n">r12_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">4.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span>
<span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">r12_1</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">5.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span>
<span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="n">table_1_byte_6_rol_1</span>
<span class="n">table_1_byte_6_rol_1</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">6.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">table_1_byte_6_rol_1</span><span class="p">.</span><span class="n">b</span>
<span class="kt">char</span><span class="w"> </span><span class="n">r13_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rol</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="mi">7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">table_1_index_2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="nl">table_1_bytes__dllBase</span><span class="p">:</span><span class="mf">7.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_1_xor</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">r13_1</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="n">u</span><span class="o">&lt;</span><span class="w"> </span><span class="n">table_1_bytes__dllBase</span><span class="p">)</span>
<span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>The disassembly is mildly more obfuscated, and given that we can assume <code>table_1_index</code> is always <code>0x1</code> (as no cross-references indicate it is overwritten, unlike other indices introduced later), then the real address of <code>table_1</code> is <code>0x7ffc3813224a</code> (the <code>lea</code> has a constant-offset of <code>0x11</code>.)  <code>table_1_xor</code> consists entirely of zeros, therefore this is just a transmutation cipher, which we can decode:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">table_1</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc1</span><span class="p">,</span>
<span class="w">        </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfb</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                </span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotl8</span><span class="w"> </span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;bytes.q=0x%&quot;</span><span class="w"> </span><span class="n">PRIx64</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Yields <code>0x7ffc380e0000</code>: the base address of the module, so we may begin to anticipate that an upper bound will come. So far, we have the following:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span>
<span class="nf">hook_KiUserExceptionDispatcher</span><span class="w"> </span><span class="p">(</span><span class="n">PEXCEPTION_RECORD</span><span class="w"> </span><span class="n">exc_record</span><span class="p">,</span><span class="w"> </span><span class="n">PCONTEXT</span><span class="w"> </span><span class="n">exc_context</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">module_base</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">table_1</span><span class="p">);</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="n">module_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotl8</span><span class="w"> </span><span class="p">(</span><span class="n">table_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">module_base</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* ... */</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>So, we're checking if the pointer to the exception's context is outside of the module's bounds: does this make sense? Yes, if the allocation was made on the heap/stack, of which the stack would seem to be the most typical case. Moving forward:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="n">u</span><span class="o">&lt;</span><span class="w"> </span><span class="n">table_1_bytes__dllBase</span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">check_context_in_stack_bounds</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context_1</span><span class="w"> </span><span class="n">u</span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">NtTib</span><span class="p">.</span><span class="n">StackLimit</span><span class="p">)</span>
<span class="w">        </span><span class="n">_0x18_if_ctx_valid_else_0x8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x18</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context_1</span><span class="w"> </span><span class="n">u</span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">NtTib</span><span class="p">.</span><span class="n">StackLimit</span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">exc_context_1</span><span class="w"> </span><span class="n">u</span><span class="o">&lt;</span><span class="w"> </span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">NtTib</span><span class="p">.</span><span class="n">StackBase</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit_check_context_in_stack_bounds</span>

<span class="w">    </span><span class="n">table_1_bytes__dllBase</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7d309f99</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">table_2_index_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zx</span><span class="p">.</span><span class="n">q</span><span class="p">(</span><span class="n">table_2_index</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">0.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">1.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">2.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">3.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">4.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">4</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">5.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">5</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">6.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">6</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nl">table_2_bytes__dllEnd</span><span class="p">:</span><span class="mf">7.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ror</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">not</span><span class="p">.</span><span class="n">b</span><span class="p">((</span><span class="o">&amp;</span><span class="n">table_2</span><span class="p">)[</span><span class="mi">7</span><span class="p">][</span><span class="n">table_2_index_1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">_0x18_if_ctx_valid_else_0x8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context_1</span><span class="w"> </span><span class="n">u</span><span class="o">&gt;=</span><span class="w"> </span><span class="n">table_2_bytes__dllEnd</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">check_context_in_stack_bounds</span>
<span class="p">}</span>
<span class="nl">exit_check_context_in_stack_bounds</span><span class="p">:</span>
</code></pre></div>

<p>Applying a similar methodology for <code>table_2</code>, we discover that it is the end of the module at <code>0x7ffc392b0000</code>, so we may simplify the branches to this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dllBase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">exc_context</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dllEnd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">is_context_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">NtTib</span><span class="p">.</span><span class="n">StackLimit</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">is_context_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x18</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exc_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NtTib</span><span class="p">.</span><span class="n">StackBase</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now, note that when cross-referencing how <code>is_context_valid</code> is used in later portions of the decompilation, it seems to be mostly meaningless to execution, however it does incur side-effects that are meaningful, i.e.:</p>
<p><img src="img//Pasted image 20251204094321.png" style="display:block;margin:0 auto;" /></p>
<p>Which in either case of a valid exception context, refers to <code>0x2e92</code> or <code>0x4883</code>--not that it is stored. Regardless, this dereferences valid memory so it has no cause for concern regarding access violations, and since we are the exception dispatcher, we (probably) wouldn't want to invoke any further exceptions on trapped page accesses or similar, so we may likely treat this as benign.
This begs the question, what is the state differential when the context is out of bounds versus otherwise? </p>

    </main>
    <footer>
      <hr>
      
  <a href="/">&gt; home</a>

    </footer>
  </body>
</html>